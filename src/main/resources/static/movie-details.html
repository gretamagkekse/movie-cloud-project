<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <div class="container">
        <ul class="navbar-nav">
            <li id="indexLink" class="nav-item">
                <a href="index.html" class="nav-link">All movies</a>
            </li>
            <li id="loginLink" class="nav-item">
                <a href="login.html" class="nav-link">Login</a>
            </li>
            <li id="logoutLink" class="nav-item" hidden>
                <a class="nav-link" onclick="logout()">Logout</a>
            </li>
            <li id="profileLink" class="nav-item" hidden>
                <a href="profile.html" class="nav-link">Profile</a>
            </li>
        </ul>
    </div>
</nav>
<div class="container">
    <h1 id="movie-title" class="text-center my-4">Movie Title</h1>

    <div class="row">
        <div class="col-md-4">
            <img id="movie-poster" src="" alt="Movie Poster" class="img-fluid">
        </div>
        <div class="col-md-8">
            <h3>Overview</h3>
            <p id="movie-overview"></p>

            <h4>IMDb Rating: <span id="movie-vote"></span></h4>
            <h4 id="movie-average-rating">Average Rating: No ratings available</h4>
            <!-- Optionally display averages for each category -->
            <p id="average-actors"></p>
            <p id="average-story"></p>
            <p id="average-visuals"></p>
        </div>
    </div>

    <!-- Comments Section -->
    <h3 class="mt-5">Comments and Ratings</h3>
    <ul id="comments-list" class="list-group mb-4">
        <!-- Comments will be dynamically loaded here -->

    </ul>

    <!-- Add Comment Form -->
    <div class="card" id="comment-section" hidden>
        <div class="card-body">
            <h5 class="card-title">Add Your Comment</h5>
            <form id="comment-form">

                <div class="mb-3">
                    <label for="content"></label><textarea id="content" class="form-control" placeholder="Your Comment" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="ratingActors"></label><input type="number" id="ratingActors" class="form-control" placeholder="Your Rating of the actors (1-5)" min="1" max="5" step="1" required>
                </div>
                <div class="mb-3">
                    <label for="ratingStory"></label><input type="number" id="ratingStory" class="form-control" placeholder="Your Rating of the story (1-5)" min="1" max="5" step="1" required>
                </div>
                <div class="mb-3">
                    <label for="ratingVisuals"></label><input type="number" id="ratingVisuals" class="form-control" placeholder="Your Rating of the visuals (1-5)" min="1" max="5" step="1" required>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="js/nav.js" type="application/javascript"></script>
<script>
    const params = new URLSearchParams(window.location.search);
    const movieId = params.get("id");

    // Function to load movie details
    function loadMovieDetails() {
        fetch(`/api/movie/${movieId}`)
            .then(response => {
            if (!response.ok) {
                throw new Error(`Error fetching movie details: ${response.status}`);
            }
            return response.json();
        })
            .then(movie => {
            console.log("Movie details:", movie);

            // update the HTML
            document.getElementById("movie-title").innerText = movie.title;
            document.getElementById("movie-overview").innerText = movie.overview;

            // Check and display vote average with one decimal point
            if (movie.voteAverage !== undefined && movie.voteAverage !== null) {
                document.getElementById("movie-vote").innerText = movie.voteAverage.toFixed(1);  // Format to 1 decimal place
            } else if (movie.vote_average !== undefined && movie.vote_average !== null) {
                document.getElementById("movie-vote").innerText = movie.vote_average.toFixed(1);  // Format to 1 decimal place
            } else {
                document.getElementById("movie-vote").innerText = "No vote average available";
            }

            document.getElementById("movie-poster").src = movie.fullPosterPath;
        })
            .catch(error => {
            console.error("Error fetching movie details:", error);
            alert("Failed to load movie details.");
        });
    }

    // load comments for the movie and calculate average rating
    function loadCommentsAndCalculateAverage() {
        fetch(`/api/comments/${movieId}`)
            .then(response => response.json())
            .then(comments => {
            const commentsList = document.getElementById("comments-list");
            commentsList.innerHTML = ''; // Clear previous comments

            let totalRatingActors = 0, totalRatingStory = 0, totalRatingVisuals = 0, commentCount = 0;

            comments.forEach(comment => {
                // Add each comment to the list
                const listItem = document.createElement("li");
                listItem.className = "list-group-item";
                listItem.innerHTML = `<strong>Actors:</strong> (${comment.ratingActors}/5),
                                      <strong>Story:</strong> (${comment.ratingStory}/5),
                                      <strong>Visuals:</strong> (${comment.ratingVisuals}/5): ${comment.comment}`;
                commentsList.appendChild(listItem);

                // Sum up the ratings
                totalRatingActors += comment.ratingActors;
                totalRatingStory += comment.ratingStory;
                totalRatingVisuals += comment.ratingVisuals;
                commentCount++;
            });

            // Calculate average ratings
            if (commentCount > 0) {
                const avgRatingActors = totalRatingActors / commentCount;
                const avgRatingStory = totalRatingStory / commentCount;
                const avgRatingVisuals = totalRatingVisuals / commentCount;

                const avgTotalRating = (avgRatingActors + avgRatingStory + avgRatingVisuals) / 3;

                //display the average ratings
                document.getElementById("movie-average-rating").innerText = `Average Rating: ${avgTotalRating.toFixed(1)} / 5`;

                //display individual category averages
                document.getElementById("average-actors").innerText = `Actors: ${avgRatingActors.toFixed(1)} / 5`;
                document.getElementById("average-story").innerText = `Story: ${avgRatingStory.toFixed(1)} / 5`;
                document.getElementById("average-visuals").innerText = `Visuals: ${avgRatingVisuals.toFixed(1)} / 5`;
            } else {
                // If no comments, display no rating available
                document.getElementById("movie-average-rating").innerText = "No ratings available";
            }
        })
            .catch(error => console.error("Error fetching comments:", error));
    }

    // Handle form submission for adding a comment
    document.getElementById("comment-form").addEventListener("submit", function(event) {
        const userCredentialString = sessionStorage.getItem("userCredential");
        const userCredential = JSON.parse(userCredentialString);
        console.log(userCredential)
        const auth = btoa(userCredential.username + ':' + userCredential.password);

        event.preventDefault();

        const commentData = {
            ratingActors: parseInt(document.getElementById("ratingActors").value, 10),
            ratingStory: parseInt(document.getElementById("ratingStory").value, 10),
            ratingVisuals: parseInt(document.getElementById("ratingVisuals").value, 10),
            comment: document.getElementById("content").value
        };

        console.log(commentData)
        fetch(`/api/comments/${movieId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                'Authorization': 'Basic ' + auth
            },
            body: JSON.stringify(commentData)
        })
            .then(response => {
                if (response.status === 401) {
                    alert("Unauthorized: Please log in.");
                    window.location.href = 'login.html';
                } else if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }
                return response.json();
            })

            .then(() => {
            loadComments();  // Reload the comments after submission
            document.getElementById("comment-form").reset();  // Clear the form
        })
            .catch(error => console.error("Error submitting comment:", error));
    });


    // Load movie details and comments when the page loads
    loadMovieDetails();
    loadCommentsAndCalculateAverage();
</script>



</body>
</html>

